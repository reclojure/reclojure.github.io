{"version":3,"sources":["portal/runtime/web/launcher.cljs"],"mappings":"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","names":["portal.runtime.web.launcher/str->src","value","content-type","blob","js/Blob","url","or__4223__auto__","js/window.URL","js/window.webkitURL","portal.runtime.web.launcher/get-item","k","js/window.localStorage.getItem","portal.runtime.web.launcher/set-item","v","js/window.localStorage.setItem","portal.runtime.web.launcher/remove-item","js/localStorage.removeItem","js/portal","js/portal.runtime","js/portal.runtime.web","js/portal.runtime.web.launcher","js/portal.runtime.web.launcher.child-window","portal.runtime.web.launcher/child-window","cljs.core.atom","js/portal.runtime.web.launcher.code","portal.runtime.web.launcher/code","js/portal.runtime.web.launcher.code-url","portal.runtime.web.launcher/code-url","portal.runtime.web.launcher/not-found","_request","done","G__56777","portal.runtime.web.launcher/send!","message","js/Promise","resolve","_reject","session","portal.runtime/open-session","portal.runtime.web.client/session","body","portal.runtime/read","f","cljs.core.get","portal.runtime/ops","*session*-orig-val__56779","*session*-temp-val__56780","portal.runtime/*session*","G__56781","G__56782","p1__56778#","G__56783","portal.runtime/write","portal.runtime.web.launcher/open","options","cljs.core.swap_BANG_","portal.runtime/sessions","cljs.core/assoc-in","portal.runtime.index.html","child","js/window.open","cljs.core/reset!","js/window","js/Date.now","portal.runtime/request","cljs.core.partial","portal.runtime.web.client/request","portal.runtime.web.launcher/init","temp__5753__auto__","string","js/parseInt","portal.runtime.web.launcher/clear","portal.runtime.web.launcher/close","cljs.core/deref"],"sourcesContent":["(ns portal.runtime.web.launcher\n  (:require [portal.resources :as io]\n            [portal.runtime :as rt]\n            [portal.runtime.index :as index]\n            [portal.runtime.web.client :as c]))\n\n(defn- str->src [value content-type]\n  (let [blob (js/Blob. #js [value] #js {:type content-type})\n        url  (or js/window.URL js/window.webkitURL)]\n    (.createObjectURL url blob)))\n\n(defn- get-item [k]\n  (js/window.localStorage.getItem k))\n\n(defn- set-item [k v]\n  (js/window.localStorage.setItem k v))\n\n(defn- remove-item [k]\n  (js/localStorage.removeItem k))\n\n(defonce child-window (atom nil))\n(defonce code (io/resource \"portal/main.js\"))\n(defonce code-url (str->src code \"text/javascript\"))\n\n(defn- not-found [_request done]\n  (done {:status :not-found}))\n\n(defn send! [message]\n  (js/Promise.\n   (fn [resolve _reject]\n     (let [session (rt/open-session c/session)\n           body    (rt/read message session)\n           f       (get rt/ops (:op body) not-found)]\n       (binding [rt/*session* session]\n         (f body #(resolve (rt/write % session))))))))\n\n(defn open [options]\n  (swap! rt/sessions assoc-in [(:session-id c/session) :options] options)\n  (let [url   (str->src (index/html :code-url code-url :platform \"web\") \"text/html\")\n        child (js/window.open\n               url\n               \"portal\"\n               (when (:portal.launcher/app options true)\n                 \"resizable,scrollbars,status\"))]\n    (set! (.-onunload child)\n          (fn []\n            (reset! (:value-cache c/session) {})\n            (remove-item \":portal/open\")))\n    (set! (.-onunload js/window)\n          (fn []\n            (when-not (.-closed child)\n              (set-item \":portal/open\" (js/Date.now)))))\n    (reset! child-window child)\n    (reset! rt/request (partial c/request child-window)))\n  true)\n\n(defn init []\n  (when-let [string (get-item \":portal/open\")]\n    (if (< (- (js/Date.now) (js/parseInt string)) 5000)\n      (open nil)\n      (remove-item \":portal/open\"))))\n\n(defn clear []\n  (c/request child-window {:op :portal.rpc/clear}))\n\n(defn close []\n  (when-let [child @child-window]\n    (reset! child-window nil)\n    (reset! rt/request nil)\n    (.close child)))\n\n"]}